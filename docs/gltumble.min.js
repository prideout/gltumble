!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.Trackball=i()}(this,function(){"use strict";var t=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function n(){var t=new i(16);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function r(i,n,r){var e,s,a,o=r[0],h=r[1],c=r[2],u=Math.sqrt(o*o+h*h+c*c);return u<t?null:(o*=u=1/u,h*=u,c*=u,e=Math.sin(n),a=1-(s=Math.cos(n)),i[0]=o*o*a+s,i[1]=h*o*a+c*e,i[2]=c*o*a-h*e,i[3]=0,i[4]=o*h*a-c*e,i[5]=h*h*a+s,i[6]=c*h*a+o*e,i[7]=0,i[8]=o*c*a+h*e,i[9]=h*c*a-o*e,i[10]=c*c*a+s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i)}function e(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,n,r){var e=new i(3);return e[0]=t,e[1]=n,e[2]=r,e}function a(t,i,n){var r=i[0],e=i[1],s=i[2],a=n[0],o=n[1],h=n[2];return t[0]=e*h-s*o,t[1]=s*a-r*h,t[2]=r*o-e*a,t}var o,h=function(t){var i=t[0],n=t[1],r=t[2];return Math.sqrt(i*i+n*n+r*r)};o=e();!function(){var t,n=(t=new i(4),i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function c(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function u(i,n,r,e){var s=n[0],a=n[1],o=n[2],h=n[3],c=r[0],u=r[1],p=r[2],g=r[3],l=void 0,f=void 0,v=void 0,d=void 0,S=void 0;return(f=s*c+a*u+o*p+h*g)<0&&(f=-f,c=-c,u=-u,p=-p,g=-g),1-f>t?(l=Math.acos(f),v=Math.sin(l),d=Math.sin((1-e)*l)/v,S=Math.sin(e*l)/v):(d=1-e,S=e),i[0]=d*s+S*c,i[1]=d*a+S*u,i[2]=d*o+S*p,i[3]=d*h+S*g,i}var p,g,l,f,v,d,S,P=function(t,i){var n=i[0],r=i[1],e=i[2],s=i[3],a=n*n+r*r+e*e+s*s;return a>0&&(a=1/Math.sqrt(a),t[0]=n*a,t[1]=r*a,t[2]=e*a,t[3]=s*a),t};p=e(),g=s(1,0,0),l=s(0,1,0),f=c(),v=c(),d=new i(9),i!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[5]=0,d[6]=0,d[7]=0),d[0]=1,d[4]=1,d[8]=1,S=d;function y(){var t=new i(2);return i!=Float32Array&&(t[0]=0,t[1]=0),t}function M(t,i,n){return t[0]=i[0]-n[0],t[1]=i[1]-n[1],t}!function(){var t=y()}();var m=Object.freeze({autoTick:!0,startSpin:.02,allowTilt:!0,allowSpin:!0,spinFriction:.125,epsilon:3,radiansPerPixel:[.01,.01],trackpad:!0,lockAxes:!1,homeTilt:.25}),b=Object.freeze({Resting:0,SpinningStart:1,SpinningInertia:2,DraggingInit:3,DraggingSpin:4,DraggingTilt:5}),A=function(t,i){if(this.config={},Object.assign(this.config,m),Object.assign(this.config,i),this.config=Object.freeze(this.config),this.config.autoTick&&(this.tick=this.tick.bind(this),window.requestAnimationFrame(this.tick)),t){var n=this.mouse.bind(this);t.addEventListener("wheel",n),t.addEventListener("pointermove",n),t.addEventListener("pointerdown",n),t.addEventListener("pointerup",n)}this.startPosition=[0,0],this.currentPosition=[0,0],this.previousPosition=this.currentPosition.slice(),this.previous2Position=this.currentPosition.slice(),this.currentSpin=0,this.currentTilt=this.config.homeTilt,this.currentState=this.config.startSpin?b.SpinningInertia:b.Resting,this.previousTime=null,this.inertiaSpeed=this.config.startSpin,this.initialInertia=.125,Object.seal(this)};return A.prototype.mouse=function(t){if("touch"!==t.pointerType||t.isPrimary){var i=[t.clientX,t.clientY];"pointerdown"===t.type&&this.startDrag(i),"pointerup"===t.type&&this.endDrag(i),"pointermove"===t.type&&t.buttons&&this.updateDrag(i)}},A.prototype.tick=function(){this.config.autoTick&&window.requestAnimationFrame(this.tick);var i=Date.now();null==this.previousTime&&(this.previousTime=i);var n=i-this.previousTime;this.previousTime=i;var r,e,s,a,o,h,c=this.currentState===b.DraggingSpin||this.currentState===b.DraggingInit&&!this.config.lockAxes;this.currentState===b.SpinningStart?this.currentSpin+=this.config.startSpin*n:this.currentState===b.SpinningInertia?(this.currentSpin+=this.inertiaSpeed*n,this.inertiaSpeed*=1-this.config.spinFriction,Math.abs(this.inertiaSpeed)<1e-4&&(this.currentState=b.Resting)):this.config.trackpad&&c&&(r=this.currentPosition,e=this.previous2Position,s=r[0],a=r[1],o=e[0],h=e[1],Math.abs(s-o)<=t*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(a-h)<=t*Math.max(1,Math.abs(a),Math.abs(h)))&&(this.currentSpin+=this.inertiaSpeed*n,this.inertiaSpeed*=1-this.config.spinFriction),this.previous2Position=this.previousPosition.slice(),this.previousPosition=this.currentPosition.slice()},A.prototype.startDrag=function(t){this.startPosition=t.slice(),this.currentPosition=t.slice(),this.currentState=b.DraggingInit},A.prototype.endDrag=function(t){var i;this.currentPosition=t.slice(),i=this.getAngles(),this.currentSpin=i[0],this.currentTilt=i[1],1===this.config.spinFriction?this.currentState=b.Resting:this.currentState=b.SpinningInertia},A.prototype.updateDrag=function(t){var i=M(y(),t,this.startPosition),n=this.config;if(this.currentState===b.DraggingInit&&n.lockAxes)if(Math.abs(i[0])>n.epsilon&&n.allowSpin)this.currentState=b.DraggingSpin;else{if(!(Math.abs(i[1])>n.epsilon&&n.allowTilt))return;this.currentState=b.DraggingTilt}var r=this.getAngles()[0];this.currentPosition=t.slice();var e=this.getAngles()[0]-r;this.inertiaSpeed=this.initialInertia*e},A.prototype.getAngles=function(){var t=M(y(),this.currentPosition,this.startPosition),i=this.config,n=this.currentSpin,r=this.currentTilt;return this.currentState===b.DraggingSpin?n+=i.radiansPerPixel[0]*t[0]:this.currentState===b.DraggingTilt?r+=i.radiansPerPixel[1]*t[1]:i.lockAxes||this.currentState!==b.DraggingInit||(n+=i.radiansPerPixel[0]*t[0],r+=i.radiansPerPixel[1]*t[1]),[n,r]},A.prototype.getMatrix=function(){var t,i,e,s,a,o,h,c,u,p,g,l,f,v,d,S,P,y,M,m,b,A,T,w=this.getAngles(),D=r(n(),w[0],[0,1,0]),k=r(n(),w[1],[1,0,0]);return t=k,e=D,s=(i=k)[0],a=i[1],o=i[2],h=i[3],c=i[4],u=i[5],p=i[6],g=i[7],l=i[8],f=i[9],v=i[10],d=i[11],S=i[12],P=i[13],y=i[14],M=i[15],m=e[0],b=e[1],A=e[2],T=e[3],t[0]=m*s+b*c+A*l+T*S,t[1]=m*a+b*u+A*f+T*P,t[2]=m*o+b*p+A*v+T*y,t[3]=m*h+b*g+A*d+T*M,m=e[4],b=e[5],A=e[6],T=e[7],t[4]=m*s+b*c+A*l+T*S,t[5]=m*a+b*u+A*f+T*P,t[6]=m*o+b*p+A*v+T*y,t[7]=m*h+b*g+A*d+T*M,m=e[8],b=e[9],A=e[10],T=e[11],t[8]=m*s+b*c+A*l+T*S,t[9]=m*a+b*u+A*f+T*P,t[10]=m*o+b*p+A*v+T*y,t[11]=m*h+b*g+A*d+T*M,m=e[12],b=e[13],A=e[14],T=e[15],t[12]=m*s+b*c+A*l+T*S,t[13]=m*a+b*u+A*f+T*P,t[14]=m*o+b*p+A*v+T*y,t[15]=m*h+b*g+A*d+T*M,t},A});
