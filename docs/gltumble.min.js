!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.Trackball=i()}(this,function(){"use strict";var t=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function n(){var t=new i(16);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function e(i,n,e){var r,s,a,o=e[0],h=e[1],c=e[2],u=Math.sqrt(o*o+h*h+c*c);return u<t?null:(o*=u=1/u,h*=u,c*=u,r=Math.sin(n),a=1-(s=Math.cos(n)),i[0]=o*o*a+s,i[1]=h*o*a+c*r,i[2]=c*o*a-h*r,i[3]=0,i[4]=o*h*a-c*r,i[5]=h*h*a+s,i[6]=c*h*a+o*r,i[7]=0,i[8]=o*c*a+h*r,i[9]=h*c*a-o*r,i[10]=c*c*a+s,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1,i)}function r(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,n,e){var r=new i(3);return r[0]=t,r[1]=n,r[2]=e,r}function a(t,i,n){var e=i[0],r=i[1],s=i[2],a=n[0],o=n[1],h=n[2];return t[0]=r*h-s*o,t[1]=s*a-e*h,t[2]=e*o-r*a,t}var o,h=function(t){var i=t[0],n=t[1],e=t[2];return Math.sqrt(i*i+n*n+e*e)};o=r();!function(){var t,n=(t=new i(4),i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();function c(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function u(i,n,e,r){var s=n[0],a=n[1],o=n[2],h=n[3],c=e[0],u=e[1],g=e[2],p=e[3],l=void 0,f=void 0,v=void 0,d=void 0,S=void 0;return(f=s*c+a*u+o*g+h*p)<0&&(f=-f,c=-c,u=-u,g=-g,p=-p),1-f>t?(l=Math.acos(f),v=Math.sin(l),d=Math.sin((1-r)*l)/v,S=Math.sin(r*l)/v):(d=1-r,S=r),i[0]=d*s+S*c,i[1]=d*a+S*u,i[2]=d*o+S*g,i[3]=d*h+S*p,i}var g,p,l,f,v,d,S,P=function(t,i){var n=i[0],e=i[1],r=i[2],s=i[3],a=n*n+e*e+r*r+s*s;return a>0&&(a=1/Math.sqrt(a),t[0]=n*a,t[1]=e*a,t[2]=r*a,t[3]=s*a),t};g=r(),p=s(1,0,0),l=s(0,1,0),f=c(),v=c(),d=new i(9),i!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[5]=0,d[6]=0,d[7]=0),d[0]=1,d[4]=1,d[8]=1,S=d;function y(){var t=new i(2);return i!=Float32Array&&(t[0]=0,t[1]=0),t}function b(t,i,n){return t[0]=i[0]-n[0],t[1]=i[1]-n[1],t}!function(){var t=y()}();var M=Object.freeze({homeTilt:.25,startSpin:.02,autoTick:!0,friction:.125}),T=Object.freeze({Resting:0,CoastingSpin:1,CoastingTilt:2,DraggingInit:3,DraggingSpin:4,DraggingTilt:5}),A=Object.freeze({allowTilt:!0,allowSpin:!0,epsilon:3,radiansPerPixel:[.01,.01],lockAxes:!1}),m=function(t,i){if(this.config={},Object.assign(this.config,A),Object.assign(this.config,M),Object.assign(this.config,i),this.config=Object.freeze(this.config),this.config.autoTick&&(this.tick=this.tick.bind(this),window.requestAnimationFrame(this.tick)),t){var n=this.handleEvent.bind(this);t.addEventListener("wheel",n),t.addEventListener("pointermove",n),t.addEventListener("pointerdown",n),t.addEventListener("pointerup",n)}this.startPosition=[0,0],this.currentPosition=[0,0],this.previousPosition=this.currentPosition.slice(),this.previous2Position=this.currentPosition.slice(),this.currentSpin=0,this.currentTilt=this.config.homeTilt,this.currentState=this.config.startSpin?T.CoastingSpin:T.Resting,this.previousTime=null,this.inertiaSpeed=this.config.startSpin,this.initialInertia=.125,Object.seal(this)};return m.prototype.handleEvent=function(t){if("touch"!==t.pointerType||t.isPrimary){var i=[t.clientX,t.clientY];"pointerdown"===t.type&&this.startDrag(i),"pointerup"===t.type&&this.endDrag(i),"pointermove"===t.type&&t.buttons&&this.updateDrag(i)}},m.prototype.tick=function(){this.config.autoTick&&window.requestAnimationFrame(this.tick);var i=Date.now();null==this.previousTime&&(this.previousTime=i);var n=i-this.previousTime;this.previousTime=i;var e,r,s,a,o,h,c=this.currentState===T.DraggingSpin||this.currentState===T.DraggingInit&&!this.config.lockAxes;this.currentState===T.CoastingSpin?(this.currentSpin+=this.inertiaSpeed*n,this.inertiaSpeed*=1-this.config.friction,Math.abs(this.inertiaSpeed)<1e-4&&(this.currentState=T.Resting)):c&&(e=this.currentPosition,r=this.previous2Position,s=e[0],a=e[1],o=r[0],h=r[1],Math.abs(s-o)<=t*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(a-h)<=t*Math.max(1,Math.abs(a),Math.abs(h)))&&(this.currentSpin+=this.inertiaSpeed*n,this.inertiaSpeed*=1-this.config.friction),this.previous2Position=this.previousPosition.slice(),this.previousPosition=this.currentPosition.slice()},m.prototype.startDrag=function(t){this.startPosition=t.slice(),this.currentPosition=t.slice(),this.currentState=T.DraggingInit},m.prototype.endDrag=function(t){var i;this.currentPosition=t.slice(),i=this.getAngles(),this.currentSpin=i[0],this.currentTilt=i[1],1===this.config.friction?this.currentState=T.Resting:this.currentState=T.CoastingSpin},m.prototype.updateDrag=function(t){var i=b(y(),t,this.startPosition),n=this.config;if(this.currentState===T.DraggingInit&&n.lockAxes)if(Math.abs(i[0])>n.epsilon&&n.allowSpin)this.currentState=T.DraggingSpin;else{if(!(Math.abs(i[1])>n.epsilon&&n.allowTilt))return;this.currentState=T.DraggingTilt}var e=this.getAngles()[0];this.currentPosition=t.slice();var r=this.getAngles()[0]-e;this.inertiaSpeed=this.initialInertia*r},m.prototype.getAngles=function(){var t=b(y(),this.currentPosition,this.startPosition),i=this.config,n=this.currentSpin,e=this.currentTilt;return this.currentState===T.DraggingSpin?n+=i.radiansPerPixel[0]*t[0]:this.currentState===T.DraggingTilt?e+=i.radiansPerPixel[1]*t[1]:i.lockAxes||this.currentState!==T.DraggingInit||(n+=i.radiansPerPixel[0]*t[0],e+=i.radiansPerPixel[1]*t[1]),[n,e]},m.prototype.getMatrix=function(){var t,i,r,s,a,o,h,c,u,g,p,l,f,v,d,S,P,y,b,M,T,A,m,w=this.getAngles(),D=e(n(),w[0],[0,1,0]),x=e(n(),w[1],[1,0,0]);return t=x,r=D,s=(i=x)[0],a=i[1],o=i[2],h=i[3],c=i[4],u=i[5],g=i[6],p=i[7],l=i[8],f=i[9],v=i[10],d=i[11],S=i[12],P=i[13],y=i[14],b=i[15],M=r[0],T=r[1],A=r[2],m=r[3],t[0]=M*s+T*c+A*l+m*S,t[1]=M*a+T*u+A*f+m*P,t[2]=M*o+T*g+A*v+m*y,t[3]=M*h+T*p+A*d+m*b,M=r[4],T=r[5],A=r[6],m=r[7],t[4]=M*s+T*c+A*l+m*S,t[5]=M*a+T*u+A*f+m*P,t[6]=M*o+T*g+A*v+m*y,t[7]=M*h+T*p+A*d+m*b,M=r[8],T=r[9],A=r[10],m=r[11],t[8]=M*s+T*c+A*l+m*S,t[9]=M*a+T*u+A*f+m*P,t[10]=M*o+T*g+A*v+m*y,t[11]=M*h+T*p+A*d+m*b,M=r[12],T=r[13],A=r[14],m=r[15],t[12]=M*s+T*c+A*l+m*S,t[13]=M*a+T*u+A*f+m*P,t[14]=M*o+T*g+A*v+m*y,t[15]=M*h+T*p+A*d+m*b,t},m});
